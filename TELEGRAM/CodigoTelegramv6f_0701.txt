[{"id":"4f3a4e93.cc8bf","type":"tab","label":"TELEGRAM","disabled":false,"info":""},{"id":"1061bff3.20a0a","type":"function","z":"4f3a4e93.cc8bf","name":"ultimo registro","func":"msg.limit=1;\nmsg.sort={\"date\":-1};\nmsg.payload={};\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":160,"wires":[["694263e4.7022ac"]]},{"id":"aee12c31.d8b6f","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1030,"y":200,"wires":[]},{"id":"b5c18e16.ccc3e","type":"inject","z":"4f3a4e93.cc8bf","name":"","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":200,"wires":[["694263e4.7022ac"]]},{"id":"2513f67d.419fca","type":"function","z":"4f3a4e93.cc8bf","name":"mensaje respuesta temperatura","func":"var temp=msg.payload[0].DHT11.temp\nvar fecha=msg.payload[0].date\nmsg.payload.chatId=flow.get('Usuario' || 0);\nmsg.payload.type=\"message\";\nmsg.payload.content=\"La temperatura es de \"+temp+\"ºC.\\nEste dato fue obtenido el \"+fecha+\"\";\n\n\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":660,"wires":[["44648f9.8a52f7"]]},{"id":"407b2387.6f808c","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/Temperatura","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":130,"y":600,"wires":[["36c1f246.1579ce"],[]]},{"id":"387a1bd1.8d4e54","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/help","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":250,"y":340,"wires":[["e62f29a0.e22118"]]},{"id":"44648f9.8a52f7","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"","bot":"2a1be692.da76fa","x":1270,"y":460,"wires":[[]]},{"id":"880da168.dbcb1","type":"function","z":"4f3a4e93.cc8bf","name":"+ fecha","func":"msg.payload.date = new Date();\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":80,"wires":[["b91ad2d2.e10c"]]},{"id":"c9dede8b.61035","type":"json","z":"4f3a4e93.cc8bf","name":"","property":"payload","action":"","pretty":false,"x":350,"y":40,"wires":[["868d178f.360448","880da168.dbcb1"]]},{"id":"868d178f.360448","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":550,"y":20,"wires":[]},{"id":"1c0856a7.9b67f9","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/apaga","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":130,"y":1000,"wires":[["d72cfcaf.741fa"],[]]},{"id":"397dad48.b7c4a2","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/enciende","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":200,"y":1200,"wires":[["b7cecb18.63e788"],[]]},{"id":"66c79087.fe2c1","type":"function","z":"4f3a4e93.cc8bf","name":"Identifica si llega mensaje de intensidad","func":"//guardo información de telegram\n//monto mensaje para dispositivo\nmsg.telegram=msg.payload;\nvar intensidad= msg.payload.content\nvar id = String(new Date().getTime());\nif(intensidad> 0 || intensidad<=100){\n    msg.payload={\"level\":intensidad,\"id\":id};\n    msg.topic=\"infind/GRUPO1/led/cmd\";\n// información para la función que registra la operación\nmsg.orden=true;\nmsg.id=id;\nreturn msg;\n}\n","outputs":1,"noerr":0,"x":420,"y":1080,"wires":[["886332e9.bdf5a","21b44fe1.37328"]]},{"id":"ac0bf9e7.b7cbc8","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/estado","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":150,"y":880,"wires":[["faa1aa60.e0aae8","5d67916f.e96e4"],[]]},{"id":"faa1aa60.e0aae8","type":"function","z":"4f3a4e93.cc8bf","name":"estado en variable flow","func":"//recupero estado almacenado en flow\nvar respuesta=flow.get(\"estado\") || {\"orden\":\"No definido\",\"id\":0};\n//monto respuesta telegram\nmsg.payload.content=\"Estado del LED : \"+respuesta.led+\"\\n\";\n//var fecha2= JSON(respuesta.id);\n//var fecha = new Date(fecha2);\n//var hora=fecha.toLocaleTimeString('es-ES', { timeZone: 'Europe/Madrid', hour12: false });\n//var dia =fecha.toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' });\n//msg.payload.content+=\"Consultado : \"+hora+\" (\"+dia+\")\";\nreturn msg; // send message to telegram\n\n","outputs":1,"noerr":0,"x":440,"y":960,"wires":[["ac46c1ed.385bd","592bf022.f051"]]},{"id":"d46a7b05.ab9d58","type":"comment","z":"4f3a4e93.cc8bf","name":"Respuesta del dispositivo","info":"","x":170,"y":1400,"wires":[]},{"id":"e2216199.f32df","type":"comment","z":"4f3a4e93.cc8bf","name":"Control del LED","info":"","x":140,"y":940,"wires":[]},{"id":"e62f29a0.e22118","type":"function","z":"4f3a4e93.cc8bf","name":"mensaje bienvenida","func":"if(msg.payload.content.substring(0,1)!=\"/\")\n{\n msg.payload.content=\"Hola \"+msg.originalMessage.from.first_name+\" soy un bot ejecutando en NodeRED diseñado por el Grupo 1 de  Informática Industrial!Puedo responderte a estos comandos:\\n\";\n msg.payload.content+=\"/led - Te indico los distintos comandos relacionados con el control del estado del LED\\n\";\n msg.payload.content+=\"/Sensores - Te indico los distintos comandos relacionados con los sensores que tenemos disponibles\\n\";\n msg.payload.content+=\"/ListaComandos - Te indico todos los comandos disponibles.\\n\";\n msg.payload.content+=\"/ComandosRobot - Te indico todos los comandos relacionados con el control del robot PIERO\\n\";\n return msg;\n}","outputs":1,"noerr":0,"x":540,"y":340,"wires":[["44648f9.8a52f7","af9e3af0.191208"]]},{"id":"ad50e153.1005c","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"","bot":"2a1be692.da76fa","x":1110,"y":1720,"wires":[[]]},{"id":"8d83eb8e.6a89e8","type":"function","z":"4f3a4e93.cc8bf","name":"","func":"msg.payload={};\n\nmsg.payload.chatId=-1001354631151;\nmsg.payload.type=\"message\";\nmsg.payload.content=\"El bot publica correctamente\";\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":1740,"wires":[["ad50e153.1005c"]]},{"id":"b8d52f30.53961","type":"inject","z":"4f3a4e93.cc8bf","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":500,"y":1760,"wires":[["8d83eb8e.6a89e8"]]},{"id":"688286bc.402e78","type":"mqtt in","z":"4f3a4e93.cc8bf","name":"","topic":"infind/GRUPO1/datos","qos":"2","broker":"fc5c9554.5f0878","x":160,"y":40,"wires":[["c9dede8b.61035"]]},{"id":"b91ad2d2.e10c","type":"mongodb out","z":"4f3a4e93.cc8bf","mongodb":"b1e5fae2.4dc578","name":"","collection":"II1","payonly":true,"upsert":false,"multi":false,"operation":"store","x":800,"y":120,"wires":[]},{"id":"21b44fe1.37328","type":"mqtt out","z":"4f3a4e93.cc8bf","name":"","topic":"infind/GRUPO1/led/cmd","qos":"","retain":"","broker":"fc5c9554.5f0878","x":1150,"y":1040,"wires":[]},{"id":"694263e4.7022ac","type":"mongodb in","z":"4f3a4e93.cc8bf","mongodb":"b1e5fae2.4dc578","name":"","collection":"II1","operation":"find","x":680,"y":200,"wires":[["aee12c31.d8b6f"]]},{"id":"ef921d4e.d8983","type":"mongodb in","z":"4f3a4e93.cc8bf","mongodb":"b1e5fae2.4dc578","name":"","collection":"II1","operation":"find","x":640,"y":660,"wires":[["2513f67d.419fca"]]},{"id":"a12e6650.5b88f8","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/Humedad","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":120,"y":740,"wires":[["91c54bd5.1fbe38"],[]]},{"id":"b54983f8.36758","type":"inject","z":"4f3a4e93.cc8bf","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":120,"wires":[["1061bff3.20a0a"]]},{"id":"36c1f246.1579ce","type":"function","z":"4f3a4e93.cc8bf","name":"Indica Orden Temperatura","func":"//Filtro la base de datos y almaceno el chatId\nflow.set('Usuario',msg.payload.chatId)\nmsg.payload = {};\nmsg.sort = {\"date\" : -1};\nmsg.limit = 1;\nreturn msg;\n\n","outputs":1,"noerr":0,"x":370,"y":660,"wires":[["ef921d4e.d8983"]]},{"id":"ca019293.49444","type":"mqtt in","z":"4f3a4e93.cc8bf","name":"","topic":"infind/GRUPO1/led/status","qos":"2","broker":"fc5c9554.5f0878","x":150,"y":1440,"wires":[["ec46dcc6.dbae6","d4784550.acdf88"]]},{"id":"886332e9.bdf5a","type":"function","z":"4f3a4e93.cc8bf","name":"Registra orden/espera respuesta","func":"/*\nEsta función recibe dos tipos de mensajes. Cuando se ordena un cambio en el led, \nque se trata en la parte then del if. Y cuando se recibe la confirmación del cambio, \nque se trata en la parte else del if.\nEn el primer caso (then), programamos un timeout de 3 segundos que dará un mensaje \nde error si no se recibe la confirmación. Y guardamos la información necesaria para \nhacer las gestiones posteriores.\nEn el segundo caso (else) se compruena si había una confirmación pendiente, se cancela el \ntemporizador de timeout y se da el mensaje correspondiente.\n\nEsto es un ejemplo de uso de temporizadores y almacenamiento en el contexto de un nodo función.\nTambién se muestra cómo asignar un estado al nodo.\n*/\n\n//Estas funciones son básicamente por si hubiera usuarios simultáneos\nfunction localiza_operacion(lista_operaciones, id)\n{\n    for(var i=0; i<lista_operaciones.length; i++)\n    {\n        if(lista_operaciones[i].id==id) return i;\n    }\n    return -1;\n}\n\nfunction elimina_operacion(lista_operaciones, index)\n{\n    lista_operaciones.splice(index,1);\n    context.set(\"lista_operaciones\",lista_operaciones);\n}\n\n\nif(msg.orden)\n{ // es una orden\n    var id_operacion = msg.id;\n    node.status({fill:\"yellow\", shape:\"ring\", text:\"Wait\"}); // estado del nodo\n    var id_timeout= setTimeout(function(id){    // timeout de 3 segundos\n        // is expira el temporizador, el dispositivo no responde\n        node.warn(\"ATENCION: Operacion \"+id+\" timeout\")\n        node.status({fill:\"red\", shape:\"ring\", text:\"Timeout\"});\n        //busca operación en la lista\n        var lista_operaciones = context.get(\"lista_operaciones\") || [];\n        var index=localiza_operacion(lista_operaciones, id)\n        if(index>=0)\n        {\n            msg.payload=lista_operaciones[index].telegram_info; // restaurar info telegram (chatid)\n            msg.payload.content=\"Error timeout: dispositivo no responde (id:\"+id+\")\";\n            elimina_operacion(lista_operaciones, index);\n            node.send(msg); // envía mensaje a telegram\n        }\n        else\n            node.warn(\"ATENCION: Operacion \"+id+\" no está en la lista\") \n    }, 10000, id_operacion); \n    //añade operación a la lista\n    var lista_operaciones = context.get(\"lista_operaciones\") || [];\n    var nueva_operacion = \n      {\"id\":id_operacion, \"id_timeout\":id_timeout,\"telegram_info\":msg.telegram};\n    lista_operaciones.push(nueva_operacion);\n    context.set(\"lista_operaciones\",lista_operaciones);\n    node.warn(\"Registrada nueva operación \"+id_operacion);\n    msg.payload=msg.telegram;\n    msg.payload.content=\"Orden enviada (id:\"+id_operacion+\")\";\n    return msg;\n}\nelse\n{ // es una confirmación\n    //busca operación con esta id en la lista\n    var id=msg.payload.id;\n    var lista_operaciones = context.get(\"lista_operaciones\") || [];\n    var index=localiza_operacion(lista_operaciones, id)\n    if(index>=0) // orden localizada\n    {\n        clearTimeout(lista_operaciones[index].id_timeout); // cancelo el temporizador\n        var status=msg.payload.led;\n        msg.payload=lista_operaciones[index].telegram_info; // restaura info telegram (chatid)\n        msg.payload.content=\"Respuesta del dispositivo a la orden (id:\"+id+\"), LED : \"+status;\n        elimina_operacion(lista_operaciones, index)\n        node.warn(\"Procesada respuesta operación \"+id);\n        setTimeout(function(){  // cambio estado del nodo 1.5s después para que se vea el estado anterior\n            node.status({fill:\"green\", shape:\"ring\", text:\"Ok\"});\n        }, 10000);\n        return msg; // enviar mensaje a telegram\n    }\n    else\n        node.warn(\"ATENCION: Operacion \"+id+\" no está en la lista\")\n}\n","outputs":1,"noerr":0,"x":880,"y":1180,"wires":[["3ebccbbe.5e33b4","592bf022.f051"]]},{"id":"bb19b3f3.3b4b8","type":"change","z":"4f3a4e93.cc8bf","name":"guarda estado","rules":[{"t":"set","p":"estado","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":1440,"wires":[[]]},{"id":"343cd20f.58582e","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":630,"y":1500,"wires":[]},{"id":"ec46dcc6.dbae6","type":"json","z":"4f3a4e93.cc8bf","name":"","property":"payload","action":"","pretty":false,"x":410,"y":1400,"wires":[["886332e9.bdf5a","bb19b3f3.3b4b8","343cd20f.58582e"]]},{"id":"af9e3af0.191208","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":870,"y":300,"wires":[]},{"id":"89475995.b5f598","type":"function","z":"4f3a4e93.cc8bf","name":"mensaje respuesta humedad","func":"var hum=msg.payload[0].DHT11.hum\nvar fecha=msg.payload[0].date\nmsg.payload.chatId=flow.get('Usuario' || 0);\nmsg.payload.type=\"message\";\nmsg.payload.content=\"La humedad relativa es de \"+hum+\"%.\\nEste dato fue obtenido el \"+fecha+\"\";\n\n\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":740,"wires":[["44648f9.8a52f7"]]},{"id":"b46105c.337abf8","type":"function","z":"4f3a4e93.cc8bf","name":"Humedad mayor que 90 %","func":"var humedad = msg.payload.DHT11.hum\nif(humedad >= 95)\n{\n    msg.payload={}\n    msg.payload.chatId=-1001354631151;\n    msg.payload.type=\"message\";\n    msg.payload.content=\"Alerta! La humedad ha alcanzado un valor de \"+humedad+ \" % \\n\";\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":40,"wires":[["615147c7.3f4cc8"]]},{"id":"615147c7.3f4cc8","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"","bot":"2a1be692.da76fa","x":1383.8964538574219,"y":43.88884782791138,"wires":[[]]},{"id":"2cc3c68e.7c843a","type":"function","z":"4f3a4e93.cc8bf","name":"Temperatura mayor que 25ºC","func":"var temperatura = msg.payload.DHT11.Temp\n\nif(temperatura >= 30)\n{\n    msg.payload={}\n    msg.payload.chatId=-1001354631151;\n    msg.payload.type=\"message\";\n    msg.payload.content=\"Uy! Ten cuidado que hace una temperatura de  \"+temperatura+ \"ºC. No olvides hidratarte! \\n\";\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":100,"wires":[["4832560b.f9b0a8"]]},{"id":"4832560b.f9b0a8","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"","bot":"2a1be692.da76fa","x":1349.8965911865234,"y":133.8888063430786,"wires":[[]]},{"id":"340a86a2.c23e0a","type":"comment","z":"4f3a4e93.cc8bf","name":"CHAT DIFUSIÓN TELEGRAM","info":"","x":680,"y":1640,"wires":[]},{"id":"d4784550.acdf88","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":410,"y":1520,"wires":[]},{"id":"3ebccbbe.5e33b4","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1130,"y":1320,"wires":[]},{"id":"5d67916f.e96e4","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":470,"y":860,"wires":[]},{"id":"b06c41a7.bde8d","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/consulta","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":120,"y":660,"wires":[["36c1f246.1579ce","91c54bd5.1fbe38"],[]]},{"id":"cbf1f64e.28ae58","type":"mongodb in","z":"4f3a4e93.cc8bf","mongodb":"b1e5fae2.4dc578","name":"","collection":"II1","operation":"find","x":640,"y":740,"wires":[["89475995.b5f598"]]},{"id":"91c54bd5.1fbe38","type":"function","z":"4f3a4e93.cc8bf","name":"Indica Orden Humedad","func":"//Filtro la base de datos y almaceno el chatId\nflow.set('Usuario',msg.payload.chatId)\nmsg.payload = {};\nmsg.sort = {\"date\" : -1};\nmsg.limit = 1;\nreturn msg;\n\n","outputs":1,"noerr":0,"x":370,"y":740,"wires":[["cbf1f64e.28ae58"]]},{"id":"ac46c1ed.385bd","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":730,"y":880,"wires":[]},{"id":"5f10e8c5.c7e738","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/media","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":110,"y":800,"wires":[["6c0a1fe8.e608"],[]]},{"id":"3e4e059a.f25c0a","type":"mongodb in","z":"4f3a4e93.cc8bf","mongodb":"b1e5fae2.4dc578","name":"","collection":"II1","operation":"find","x":720,"y":800,"wires":[["b6368baf.1a7618","2e15d14d.ac20fe"]]},{"id":"b6368baf.1a7618","type":"function","z":"4f3a4e93.cc8bf","name":"mensaje respuesta media","func":"\nvar humedadmedia=0;\nvar temperaturamedia=0;\nvar valorestotales= msg.payload.length;\n for (var i = 0; i < msg.payload.length; i++)\n{\n    humedadmedia=humedadmedia + msg.payload[i].DHT11.hum;\n    temperaturamedia=temperaturamedia+msg.payload[i].DHT11.temp;\n}\ntemperaturamedia=temperaturamedia/i;\nhumedadmedia=humedadmedia/i;\nmsg.payload = {};\nmsg.payload.chatId=flow.get('Usuario' || 0);\nmsg.payload.type=\"message\";\nmsg.payload.content=\"Segun una estimación entre los datos recibidos en un periodo de treinta minutos, la humedad relativa media es de \"+humedadmedia+\"% y la temperatura media es de \"+temperaturamedia+\"ºC.\\n El numero de datos totales estimados fue de \"+valorestotales+\"\"; \n\n\nreturn msg;\n\n\n","outputs":1,"noerr":0,"x":1030,"y":800,"wires":[["44648f9.8a52f7"]]},{"id":"2e15d14d.ac20fe","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":970,"y":880,"wires":[]},{"id":"6c0a1fe8.e608","type":"function","z":"4f3a4e93.cc8bf","name":"Consulta intervalo 5 y 15 mins","func":"var ms_per_minute = 60000;\n//obtiene el timestamp actual\nvar now_ms = new Date().getTime();\nflow.set('Usuario',msg.payload.chatId)\n//crear objeto con hora de hace 5 mins\nvar oneminago = new Date(now_ms-ms_per_minute);\n\nvar treintaminsago = new Date(now_ms-30*ms_per_minute);\n\n\n// selecciona fecha posterior o igual a 5 mins\nmsg.payload ={\"$and\": [{\"date\": {\"$lte\": oneminago}}, {\"date\": {\"$gte\": treintaminsago}}]}; \nmsg.sort = {\"date\":1} ;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":800,"wires":[["3e4e059a.f25c0a"]]},{"id":"b7cecb18.63e788","type":"function","z":"4f3a4e93.cc8bf","name":"Mensaje a Usuario","func":"\n msg.payload.content=\"Has seleccionado encender el led. Porfavor, responde a este mensaje, indicando de 0 a 100, la intensidad con la que quieres encender el led. Si quieres encenderlo al máximo, tu mensaje sería: 100\";\n return msg;\n","outputs":1,"noerr":0,"x":410,"y":1180,"wires":[["592bf022.f051"]]},{"id":"3747d1af.49a98e","type":"telegram receiver","z":"4f3a4e93.cc8bf","name":"uWubot","bot":"2a1be692.da76fa","saveDataDir":"","filterCommands":false,"x":130,"y":1120,"wires":[["66c79087.fe2c1","a64e5635.270058"],[]]},{"id":"d72cfcaf.741fa","type":"function","z":"4f3a4e93.cc8bf","name":"Apaga el led","func":"//guardo información de telegram\nmsg.telegram=msg.payload;\n//monto mensaje para dispositivo\nvar id = String(new Date().getTime());\nif(msg.originalMessage.text==\"/apaga\" || msg.originalMessage.text==\"/apaga@UwU87bot\")\n{\n    msg.payload={\"level\":0,\"id\":id};\n    msg.topic=\"infind/GRUPO1/led/cmd\";\n// información para la función que registra la operación\nmsg.orden=true;\nmsg.id=id;\nreturn msg\n}","outputs":1,"noerr":0,"x":330,"y":1000,"wires":[["21b44fe1.37328","886332e9.bdf5a"]]},{"id":"ee561c1c.8c2c1","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/Sensores","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":240,"y":400,"wires":[["ffa6158d.ba2d58"],[]]},{"id":"ffa6158d.ba2d58","type":"function","z":"4f3a4e93.cc8bf","name":"Funcion Sensores info","func":"\n msg.payload.content=\"Hola \"+msg.originalMessage.from.first_name+\". Te indico que comandos te indican informacion sobre los sensores. \\n\";\n msg.payload.content+=\"/Temperatura - te indica el ultimo dato respecto a la temperatura registrada por el DHT-11\\n\";\n msg.payload.content+=\"/Humedad    - te indica el ultimo dato respecto a la humedad registrada por el DHT-11\\n\";\n msg.payload.content+=\"/consulta   - Te indico simultaneamente el ultimo dato registrado por cada sensor.\\n\";\n msg.payload.content+=\"/media   - Te indico la media de la humedad y la temperatura registrada la ultima media hora.\\n\";\n msg.payload.content+=\"/ConsultaHistorica - Te permito realizar una consulta con respecto a dias atras, donde te informaré sobre distintos aspectos de la humedad y la temperatura registrados en el periodo que me indiques.\\n\"\n msg.payload.content+=\"/ConsultaHistorica - Te genero un excel con respecto a dias atras, donde te informaré sobre distintos aspectos de la humedad y la temperatura registrados en el periodo que me indiques.\\n\"\n return msg;\n","outputs":1,"noerr":0,"x":540,"y":400,"wires":[["44648f9.8a52f7"]]},{"id":"75aafec9.40543","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/ListaComandos","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":220,"y":460,"wires":[["9cd6b02e.17663"],[]]},{"id":"9cd6b02e.17663","type":"function","z":"4f3a4e93.cc8bf","name":"Funcion Lista Comandos","func":"\n msg.payload.content=\"Hola \"+msg.originalMessage.from.first_name+\". Te indico todos los comandos de los que dispongo... Usa este poder sabiamente. \\n\";\n msg.payload.content+=\"/Sensores - Te indico los distintos comandos relacionados con los sensores que tenemos disponibles\\n\";\n msg.payload.content+=\"/Temperatura - te indica el ultimo dato respecto a la temperatura registrada por el DHT-11\\n\";\n msg.payload.content+=\"/Humedad    - te indica el ultimo dato respecto a la humedad registrada por el DHT-11\\n\";\n msg.payload.content+=\"/consulta   - Te indico simultaneamente el ultimo dato registrado por cada sensor.\\n\";\n msg.payload.content+=\"/media   - Te indico la media de la humedad y la temperatura registrada la ultima media hora.\\n\";\n msg.payload.content+=\"/led - Te indico los distintos comandos relacionados con el control del estado del LED\\n\";\n msg.payload.content+=\"/enciende - enciende el led rojo a la intensidad que me indiques\\n\";\n msg.payload.content+=\"/apaga    - apaga el led rojo\\n\";\n msg.payload.content+=\"/estado   - Te indico el ultimo estado del led, indicando 0 que esta apagado, y 100 que esta encendido con maxima luminosidad.\\n\";\n msg.payload.content+=\"/ConsultaHistorica - Te permito realizar una consulta con respecto a dias atras, donde te informaré sobre distintos aspectos de la humedad y la temperatura registrados en el periodo que me indiques.\\n\"\n msg.payload.content+=\"/PieroManual - te permite controlar el robot de forma manual mediante diferentes órdenes\\n\";\n msg.payload.content+=\"/PieroAutomatico   -Activa el modo de funcionamiento automático de PIERO, donde el solo se encargará de evitar obstáculos.\\n\";\n msg.payload.content+=\"/Salir    - al activarlo, PIERO pasa a modo reposo.\\n\";\n return msg;\n","outputs":1,"noerr":0,"x":530,"y":460,"wires":[["44648f9.8a52f7"]]},{"id":"a614d29f.2bbcf","type":"function","z":"4f3a4e93.cc8bf","name":"Funcion Control Led","func":"\n msg.payload.content=\"Hola \"+msg.originalMessage.from.first_name+\". Te indico que comandos te ayudan a controlar el estado del led. \\n\";\n msg.payload.content+=\"/enciende - enciende el led rojo a la intensidad que me indiques\\n\";\n msg.payload.content+=\"/apaga    - apaga el led rojo\\n\";\n msg.payload.content+=\"/estado   - Te indico el ultimo estado del led, indicando 0 que esta apagado, y 100 que esta encendido con maxima luminosidad.\\n\";\n return msg;\n","outputs":1,"noerr":0,"x":520,"y":580,"wires":[["44648f9.8a52f7"]]},{"id":"dd9aedce.d3897","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/led","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":330,"y":580,"wires":[["a614d29f.2bbcf"],[]]},{"id":"9c4e0dcf.e3d0c","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"show keyboard","bot":"2a1be692.da76fa","x":660,"y":2000,"wires":[[]]},{"id":"de22ef40.0e3cf","type":"function","z":"4f3a4e93.cc8bf","name":"Creamos pregunta para el keyboard","func":"\ncontext.global.keyboard = { pending : true };\n\nvar opts = {\n  reply_to_message_id: msg.payload.messageId,\n  reply_markup: JSON.stringify({\n    keyboard: [\n      ['Ayer'],\n      ['Hace siete dias'],\n      ['Hace dos dias']],\n      'resize_keyboard' : true, \n      'one_time_keyboard' : true\n  })\n};\n\nmsg.payload.content = '¿Con que antigüedad deseas realizar la consulta?';\nmsg.payload.options = opts;\nreturn [ msg ];\n","outputs":"1","noerr":0,"x":310,"y":2020,"wires":[["9c4e0dcf.e3d0c"]]},{"id":"37e402eb.d99e2e","type":"telegram command","z":"4f3a4e93.cc8bf","name":"/excel","command":"/excel","bot":"2a1be692.da76fa","strict":false,"hasresponse":true,"useRegex":false,"x":70,"y":2100,"wires":[["de22ef40.0e3cf","b7d1be20.479bc"],["67c6b91c.987988"]]},{"id":"67c6b91c.987988","type":"function","z":"4f3a4e93.cc8bf","name":"Respondemos","func":"// fecha por defecto es hoy\nvar now_ms = new Date().getTime();\nvar ahora = new Date();\nvar ms_per_minute = 60000;\nvar desde2;\n\nif (context.global.keyboard.pending) {\n    context.global.keyboard.pending = false;\n    \n    if(msg.payload.content === 'Ayer') {\n        desde2=ahora.getTime()-ms_per_minute*1440; //un dia tiene 1440 minutos\n    }\n    else if(msg.payload.content === 'Hace dos dias')     {\n        desde2=ahora.getTime()-ms_per_minute*1440*2; //un dia tiene 1440 minutos. Dos dias, el doble. \n    }\n    else if(msg.payload.content === 'Hace siete dias')   {\n        desde2=ahora.getTime()-ms_per_minute*1440*7 //numero de min de 1 dia * 7 dias\n    }\n}\n\n\n// pillo los globales si los hay, si no la fecha de hoy\nvar desde = new Date(desde2);\nvar hasta = new Date(global.get(\"hasta\") || ahora); \n// el día de inicio desde las cero horas\nvar inicio = new Date(desde.getFullYear(),desde.getMonth(),desde.getDate(),0,0,0,0);\n// el día final es hasta final del día\nvar final = new Date(hasta.getFullYear(),hasta.getMonth(),hasta.getDate(),23,59,59,999);\n\nmsg.payload=\n[\n    { \"$match\": { \"date\": { \"$gte\": inicio , \"$lte\": final } } },\n    { \"$project\": {\n        \"_id\": 0,\n        \"date\": 1,\n        \"temperatura\": \"$DHT11.temp\",\n        \"humedad\": \"$DHT11.hum\",\n        }\n    },\n    { \"$sort\": {\"date\": 1} }\n];\n\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":2160,"wires":[["556a5a0b.3c2984"]]},{"id":"556a5a0b.3c2984","type":"mongodb in","z":"4f3a4e93.cc8bf","mongodb":"b1e5fae2.4dc578","name":"","collection":"II1","operation":"aggregate","x":580,"y":2160,"wires":[["e52bc6ed.c6db58","d0ae5b08.023fc8"]]},{"id":"e52bc6ed.c6db58","type":"csv","z":"4f3a4e93.cc8bf","name":"","sep":";","hdrin":"","hdrout":true,"multi":"one","ret":"\\r\\n","temp":"date, temperatura, humedad","skip":0,"x":1030,"y":2180,"wires":[["cbe634f9.e51c08","4889d92e.92e438"]]},{"id":"cbe634f9.e51c08","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1070,"y":2060,"wires":[]},{"id":"98a1316d.41072","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1290,"y":2020,"wires":[]},{"id":"d0ae5b08.023fc8","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":770,"y":2060,"wires":[]},{"id":"592bf022.f051","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"","bot":"2a1be692.da76fa","x":1010,"y":980,"wires":[[]]},{"id":"e105a4d1.1f9098","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"","bot":"2a1be692.da76fa","x":1570,"y":2280,"wires":[[]]},{"id":"b7d1be20.479bc","type":"function","z":"4f3a4e93.cc8bf","name":"Guarda Usuario","func":"//Filtro la base de datos y almaceno el chatId\nflow.set('Usuario',msg.payload.chatId)\nreturn msg;\n\n","outputs":1,"noerr":0,"x":300,"y":2240,"wires":[["a02299ee.4d2e28"]]},{"id":"a02299ee.4d2e28","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":610,"y":2240,"wires":[]},{"id":"bafc295a.630ec8","type":"telegram command","z":"4f3a4e93.cc8bf","name":"/ConsultaHistorica","command":"/ConsultaHistorica","bot":"2a1be692.da76fa","strict":false,"hasresponse":true,"useRegex":false,"x":130,"y":2420,"wires":[["38952845.5e9638","766b83ff.8b20ac"],["220a7fd6.5913a"]]},{"id":"38952845.5e9638","type":"function","z":"4f3a4e93.cc8bf","name":"Creamos pregunta para el keyboard","func":"\ncontext.global.keyboard = { pending : true };\n\nvar opts = {\n  reply_to_message_id: msg.payload.messageId,\n  reply_markup: JSON.stringify({\n    keyboard: [\n      ['Ayer','Hoy'],\n      ['Hace siete dias'],\n      ['Hace dos dias']],\n      'resize_keyboard' : true, \n      'one_time_keyboard' : true\n  })\n};\n\nmsg.payload.content = '¿Con que antigüedad deseas realizar la consulta?';\nmsg.payload.options = opts;\nreturn [ msg ];\n","outputs":"1","noerr":0,"x":410,"y":2340,"wires":[["f022bce4.a7d6c"]]},{"id":"f022bce4.a7d6c","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"show keyboard","bot":"2a1be692.da76fa","x":680,"y":2340,"wires":[[]]},{"id":"220a7fd6.5913a","type":"function","z":"4f3a4e93.cc8bf","name":"Respondemos","func":"// fecha por defecto es hoy\nvar now_ms = new Date().getTime();\nvar ahora = new Date();\nvar ms_per_minute = 60000;\nvar desde2;\n\nif (context.global.keyboard.pending) {\n    context.global.keyboard.pending = false;\n    \n    if(msg.payload.content === 'Ayer') {\n        desde2=ahora.getTime()-ms_per_minute*1440; //un dia tiene 1440 minutos\n    }\n    else if(msg.payload.content==='Hoy'){\n        \n        desde2=ahora;\n    }\n    else if(msg.payload.content === 'Hace dos dias')     {\n        desde2=ahora.getTime()-ms_per_minute*1440*2; //un dia tiene 1440 minutos. Dos dias, el doble. \n    }\n    else if(msg.payload.content === 'Hace siete dias')   {\n        desde2=ahora.getTime()-ms_per_minute*1440*7 //numero de min de 1 dia * 7 dias\n    }\n}\n\n\n// pillo los globales si los hay, si no la fecha de hoy\nvar desde = new Date(desde2);\nvar hasta = new Date(global.get(\"hasta\") || ahora); \n// el día de inicio desde las cero horas\nvar inicio = new Date(desde.getFullYear(),desde.getMonth(),desde.getDate(),0,0,0,0);\n// el día final es hasta final del día\nvar final = new Date(hasta.getFullYear(),hasta.getMonth(),hasta.getDate(),23,59,59,999);\n\nmsg.payload=\n[\n    { \"$match\": { \"date\": { \"$gte\": inicio , \"$lte\": final } } },\n    { \"$project\": {\n        \"temperatura\": \"$DHT11.temp\",\n        \"humedad\":\"$DHT11.hum\"\n        }\n    },\n    { \"$group\": {\n        \"_id\": 0,\n        \"Tmedia\":{\"$avg\":\"$temperatura\"},\n        \"Tmax\":  {\"$max\":\"$temperatura\"},\n        \"Tmin\":  {\"$min\":\"$temperatura\"},\n        \"Hmedia\":{\"$avg\":\"$humedad\"},\n        \"Hmax\":  {\"$max\":\"$humedad\"},\n        \"Hmin\":  {\"$min\":\"$humedad\"},\n        \"datos\": {\"$sum\":1}\n    }}\n];\n\nreturn msg;\n\n\n","outputs":1,"noerr":0,"x":360,"y":2440,"wires":[["77871d4b.e7e7a4"]]},{"id":"77871d4b.e7e7a4","type":"mongodb in","z":"4f3a4e93.cc8bf","mongodb":"b1e5fae2.4dc578","name":"","collection":"II1","operation":"aggregate","x":620,"y":2440,"wires":[["35cd42c1.4a47be","bc2643fd.1c547"]]},{"id":"35cd42c1.4a47be","type":"function","z":"4f3a4e93.cc8bf","name":"mensaje respuesta agreg","func":"var tmedia=msg.payload[0].Tmedia\nvar tmax= msg.payload[0].Tmax\nvar tmin= msg.payload[0].Tmin\nvar hmedia=msg.payload[0].Hmedia\nvar hmax= msg.payload[0].Hmax\nvar hmin= msg.payload[0].Hmin\nvar datos= msg.payload[0].datos\n\nmsg.payload.chatId=flow.get('Usuario' || 0);\nmsg.payload.type=\"message\";\nmsg.payload.content=\"La temperatura media es de \"+tmedia+\"ºC.\\nLa temperatura maxima fue de \"+tmax+\"ºC y la minima fue de \"+tmin+\"ºC.\\nRespecto a la humedad, la humedad media es de \"+hmedia+\". La humedad maxima fue de \"+hmax+\"% y la humedad minima fue de \"+hmin+\"%. Se han consultado un total de \"+datos+\" datos.\\n\";\n\n\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":2440,"wires":[["e105a4d1.1f9098"]]},{"id":"bc2643fd.1c547","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":930,"y":2360,"wires":[]},{"id":"766b83ff.8b20ac","type":"function","z":"4f3a4e93.cc8bf","name":"Guarda Usuario","func":"//Filtro la base de datos y almaceno el chatId\nflow.set('Usuario',msg.payload.chatId)\nreturn msg;\n\n","outputs":1,"noerr":0,"x":340,"y":2520,"wires":[[]]},{"id":"d898e025.d1f15","type":"telegram command","z":"4f3a4e93.cc8bf","name":"/PieroManual","command":"/PieroManual","bot":"2a1be692.da76fa","strict":false,"hasresponse":true,"useRegex":false,"x":130,"y":2640,"wires":[["c6a84ed0.f04c3","e21f4808.f77ef8","f16e13d4.22b5b"],[]]},{"id":"c6a84ed0.f04c3","type":"function","z":"4f3a4e93.cc8bf","name":"Creamos pregunta para el keyboard","func":"\ncontext.global.keyboard = { pending : true };\n\nvar opts = {\n  reply_to_message_id: msg.payload.messageId,\n  reply_markup: JSON.stringify({\n    keyboard: [\n      ['W'],\n      ['A','S','D'],\n      ['STOP'],\n      ['/Salir']],\n      'resize_keyboard' : true, \n      'one_time_keyboard' : false\n  })\n};\n\nmsg.payload.content = '¡Controle su propio PIERO! Con los siguientes comandos podrá controlar el movimiento de su robot:\\n W - Avanza hacia delante\\n A - Gira hacia la izquierda\\n D - Gira hacia la derecha \\n S - Reduce velocidad \\n Stop - Para el PIERO\\n -/Salir -Salir del modo de conduccion manual\\nRecuerde que si quiere mayor velocidad, puede pulsar más de una vez la tecla! ¡Disfrute el control!';\nmsg.payload.options = opts;\nreturn [ msg ];\n\n\n","outputs":"1","noerr":0,"x":510,"y":2760,"wires":[["2e98455c.67f49a","2dd5a068.9c2dd"]]},{"id":"2dd5a068.9c2dd","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"show keyboard","bot":"2a1be692.da76fa","x":860,"y":2740,"wires":[[]]},{"id":"cba65441.ebf828","type":"function","z":"4f3a4e93.cc8bf","name":"Robot Movimiento","func":"// fecha por defecto es hoy\n\nif (context.global.keyboard.pending) {\n\n    if(msg.payload.content === 'W') {\n        msg.payload={};\n        msg.payload={\"orden\": 8};\n        return msg;\n\n    }\n    else if(msg.payload.content==='A'){\n        msg.payload={};\n        msg.payload={\"orden\": 4};\n        return msg;\n    }\n    else if(msg.payload.content === 'S')     {\n        msg.payload={};\n        msg.payload={\"orden\": 2};\n        return msg;\n    }\n    else if(msg.payload.content === 'D')   {\n        msg.payload={};\n        msg.payload={\"orden\": 6};\n        return msg;\n    }\n    else if(msg.payload.content === 'STOP')   {\n        msg.payload={};\n        msg.payload={\"orden\": 0};\n        return msg;\n    }\n    else if(msg.payload.content === '/Salir')   {\n        msg.payload={};\n        msg.payload={\"orden\": 0};\n        context.global.keyboard.pending = false;\n        return msg;\n\n    }\n}\n","outputs":1,"noerr":0,"x":470,"y":2940,"wires":[["614c0a92.88b864","308b6ad0.99dbf6"]]},{"id":"e21f4808.f77ef8","type":"function","z":"4f3a4e93.cc8bf","name":"Guarda Usuario","func":"//Filtro la base de datos y almaceno el chatId\nflow.set('Usuario',msg.payload.chatId)\nreturn msg;\n\n","outputs":1,"noerr":0,"x":500,"y":2680,"wires":[[]]},{"id":"614c0a92.88b864","type":"mqtt out","z":"4f3a4e93.cc8bf","name":"","topic":"infind/GRUPO1/PIERO/Movimiento","qos":"","retain":"","broker":"b25567ea.2cea98","x":760,"y":3080,"wires":[]},{"id":"2e98455c.67f49a","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":870,"y":2680,"wires":[]},{"id":"55b3ee35.79584","type":"telegram command","z":"4f3a4e93.cc8bf","name":"/Salir","command":"/Salir","bot":"2a1be692.da76fa","strict":false,"hasresponse":true,"useRegex":false,"x":110,"y":3080,"wires":[["2672d0bb.8c19d","7dd2acb2.bd0264"],[]]},{"id":"2672d0bb.8c19d","type":"function","z":"4f3a4e93.cc8bf","name":"Creamos pregunta para el keyboard","func":"\ncontext.global.keyboard = { pending : true };\n\nvar opts = {\n  reply_to_message_id: msg.payload.messageId,\n  reply_markup: JSON.stringify({\n    keyboard: [\n      ['Si','/PieroManual']],\n      'resize_keyboard' : true, \n      'one_time_keyboard' : true\n  })\n};\n\nmsg.payload.content = '¿Desea parar?';\nmsg.payload.options = opts;\nreturn [ msg ];\n","outputs":"1","noerr":0,"x":410,"y":3160,"wires":[["2bd04e3.f549fb2"]]},{"id":"2bd04e3.f549fb2","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"show keyboard","bot":"2a1be692.da76fa","x":720,"y":3160,"wires":[[]]},{"id":"7dd2acb2.bd0264","type":"function","z":"4f3a4e93.cc8bf","name":"Guarda Usuario","func":"//Filtro la base de datos y almaceno el chatId\nflow.set('Usuario',msg.payload.chatId)\nreturn msg;\n\n","outputs":1,"noerr":0,"x":360,"y":3100,"wires":[[]]},{"id":"c391157a.3973e8","type":"function","z":"4f3a4e93.cc8bf","name":"Robot Movimiento","func":"// fecha por defecto es hoy\n\nif (context.global.keyboard.pending) {\n    \n    \n    if(msg.payload.content === 'W') {\n        msg.payload={};\n        msg2={};\n        msg.payload={\"orden\": 8};\n        msg2.payload.chatId=flow.get('Usuario' || 0);\n        msg2.payload.type=\"message\";\n    }\n    else if(msg.payload.content==='A'){\n        msg.payload={};\n        msg.payload={\"orden\": 4};\n        msg2.payload.chatId=flow.get('Usuario' || 0);\n    }\n    else if(msg.payload.content === 'S')     {\n        msg.payload={};\n        msg.payload={\"orden\": 2};\n        msg2=msg;\n    }\n    else if(msg.payload.content === 'D')   {\n        msg.payload={};\n        msg.payload={\"orden\": 6};\n    }\n    else if(msg.payload.content === 'STOP')   {\n        msg.payload={};\n        msg.payload={\"orden\": 0};\n    }\n    else if(msg.payload.content === 'FIN')   {\n        msg.payload={};\n        msg.payload={\"orden\": 0};\n        context.global.keyboard.pending = true;\n    }\n}\n\nreturn [msg,msg2];\n\n\n","outputs":2,"noerr":0,"x":850,"y":2560,"wires":[[],[]]},{"id":"d8f51acd.950308","type":"telegram receiver","z":"4f3a4e93.cc8bf","name":"uWubot","bot":"2a1be692.da76fa","saveDataDir":"","filterCommands":false,"x":90,"y":2920,"wires":[["cba65441.ebf828","c9b884a.f48fb78","25296c1d.9dc004"],[]]},{"id":"f16e13d4.22b5b","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":530,"y":2620,"wires":[]},{"id":"c9b884a.f48fb78","type":"function","z":"4f3a4e93.cc8bf","name":"Modo Funcionamiento Robot","func":"//guardo información de telegram\nmsg.telegram=msg.payload;\n//monto mensaje para dispositivo\nif(msg.originalMessage.text==\"/PieroManual\" || msg.originalMessage.text==\"/PieroManual@UwU87bot\")\n{\n    msg={}\n    msg.payload={\"Modo\":1};\n    msg.topic=\"infind/GRUPO1/PIERO/Modo\"\n// información para la función que registra la operación\nmsg.orden=true;\nreturn msg\n}\nelse if(msg.payload.content==\"/Salir\")\n{\n    msg={}\n    msg.payload={\"Modo\":0};\n    msg.topic=\"infind/GRUPO1/PIERO/Modo\"\n    return msg\n}\nelse if(msg.payload.content==\"/PieroAutomatico\")\n{\n    msg={}\n    msg.payload={\"Modo\":2};\n    msg.topic=\"infind/GRUPO1/PIERO/Modo\"\n    return msg\n}","outputs":1,"noerr":0,"x":460,"y":2860,"wires":[["1194c9d9.b0c4a6","b7da0573.e99588"]]},{"id":"1194c9d9.b0c4a6","type":"mqtt out","z":"4f3a4e93.cc8bf","name":"","topic":"infind/GRUPO1/PIERO/Modo","qos":"","retain":"","broker":"b25567ea.2cea98","x":860,"y":2920,"wires":[]},{"id":"a6edeb78.1e5ad8","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/start","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":250,"y":280,"wires":[["e62f29a0.e22118"],[]]},{"id":"b1f8420d.507e2","type":"telegram command","z":"4f3a4e93.cc8bf","name":"","command":"/ComandosRobot","bot":"2a1be692.da76fa","strict":false,"hasresponse":false,"useRegex":false,"x":220,"y":520,"wires":[["7c1a82d6.a2258c"],[]]},{"id":"7c1a82d6.a2258c","type":"function","z":"4f3a4e93.cc8bf","name":"Funcion Sensores info","func":"\n msg.payload.content=\"Hola \"+msg.originalMessage.from.first_name+\". Te indico que comandos te indican informacion sobre los sensores. \\n\";\n msg.payload.content+=\"/PieroManual - te permite controlar el robot de forma manual mediante diferentes órdenes\\n\";\n msg.payload.content+=\"/PieroAutomatico   -Activa el modo de funcionamiento automático de PIERO, donde el solo se encargará de evitar obstáculos.\\n\";\n msg.payload.content+=\"/Salir    - al activarlo, PIERO pasa a modo reposo.\\n\";\n return msg;\n","outputs":1,"noerr":0,"x":520,"y":520,"wires":[["44648f9.8a52f7"]]},{"id":"cdac6000.cfe","type":"ui_template","z":"4f3a4e93.cc8bf","group":"a47aace4.089e4","name":"","order":3,"width":"0","height":"0","format":"<style>\n.button {\n    text-align: center;\n    font: bold 17px Arial;\n    text-decoration: none;\n    background-color: #339966;\n    color: white;\n    padding: 8px 10px;\n    border: 2px solid #CCCCCC;\n  }\n  \n  .button:hover\n  {\n   background-color: #26734d;\n  }\n\n</style>\n<a href=\"/registros\" class=\"button\">Descarga registros en CSV (EXCEL)</a>\n","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":300,"y":1940,"wires":[["678ddfad.0f3d4"]]},{"id":"678ddfad.0f3d4","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":490,"y":1920,"wires":[]},{"id":"6e3fdb88.ce2274","type":"http request","z":"4f3a4e93.cc8bf","name":"","method":"GET","ret":"txt","url":"","x":850,"y":1920,"wires":[[]]},{"id":"4577d69a.463518","type":"http response","z":"4f3a4e93.cc8bf","name":"","statusCode":"","headers":{"Content-Disposition":"attachment; filename=registros.csv"},"x":1050,"y":1920,"wires":[]},{"id":"25296c1d.9dc004","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":370,"y":3000,"wires":[]},{"id":"fb4d6d36.2c81b","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1590,"y":2060,"wires":[]},{"id":"4889d92e.92e438","type":"function","z":"4f3a4e93.cc8bf","name":"mensaje respuesta excel","func":"msg.payload.chatId=flow.get('Usuario' || 0);\nmsg.payload.type='document';\nmsg.payload.content='\\ufeff'+msg.payload;\n//msg.payload.document='/prueba.pdf'\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":2180,"wires":[["e105a4d1.1f9098","fb4d6d36.2c81b"]]},{"id":"ee94fcba.b18da","type":"chatbot-document","z":"4f3a4e93.cc8bf","name":"","filename":"","document":"","caption":"","x":1270,"y":2260,"wires":[[]]},{"id":"a64e5635.270058","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":370,"y":1140,"wires":[]},{"id":"7a7a389d.838078","type":"function","z":"4f3a4e93.cc8bf","name":"comentario pieroautomatico","func":"msg.payload.type=\"message\";\nmsg.payload.content = 'Has activado el modo automático de PIERO. En este modo, el robot comenzará a moverse automáticamente y a evitar obstáculos. Si quieres salir de este modo, puedes pulsar /Salir para salir de este modo.\\n';\nmsg.payload.chatId=flow.get('Usuario' || 0);\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":2820,"wires":[["41dd7844.325088"]]},{"id":"9063b475.daa938","type":"telegram command","z":"4f3a4e93.cc8bf","name":"/Pieroauto","command":"/PieroAutomatico","bot":"2a1be692.da76fa","strict":false,"hasresponse":true,"useRegex":false,"x":140,"y":2760,"wires":[["7a7a389d.838078","e21f4808.f77ef8"],[]]},{"id":"41dd7844.325088","type":"telegram sender","z":"4f3a4e93.cc8bf","name":"","bot":"2a1be692.da76fa","x":1250,"y":2860,"wires":[[]]},{"id":"42668548.1dfe7c","type":"mqtt in","z":"4f3a4e93.cc8bf","name":"","topic":"infind/GRUPO1/PIERO/Obstaculo","qos":"2","broker":"b25567ea.2cea98","x":200,"y":3300,"wires":[["3a0a982a.6f6758"]]},{"id":"3a0a982a.6f6758","type":"json","z":"4f3a4e93.cc8bf","name":"","property":"payload","action":"","pretty":false,"x":450,"y":3300,"wires":[["19b429a7.8ec066","9b8380e2.b8cf5"]]},{"id":"19b429a7.8ec066","type":"function","z":"4f3a4e93.cc8bf","name":"Funcion Obstáculos","func":"if(msg.payload.Sensores[\"1\"] == 'izquierda')\n{ \n    msg.payload={};\n    msg.payload.chatId=flow.get('Usuario' || 0);\n    msg.payload.content=\"Se ha detectado un obstáculo por la izquierda. Evitalo!!!\"\n    msg.payload.type=\"message\"\n    return msg;\n}\n\nelse if (msg.payload.Sensores[\"1\"] == 'derecha')\n{\n    msg.payload={};\n    msg.payload.chatId=flow.get('Usuario' || 0);\n    msg.payload.content=\"Se ha detectado un obstáculo por la derecha. Evitalo!!!\"\n    msg.payload.type=\"message\"\n    return msg;\n    \n}\n\n","outputs":1,"noerr":0,"x":700,"y":3300,"wires":[["41dd7844.325088"]]},{"id":"9b8380e2.b8cf5","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":570,"y":3440,"wires":[]},{"id":"b7da0573.e99588","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":790,"y":2860,"wires":[]},{"id":"308b6ad0.99dbf6","type":"debug","z":"4f3a4e93.cc8bf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":790,"y":3000,"wires":[]},{"id":"2a1be692.da76fa","type":"telegram bot","z":"","botname":"UwU87bot","usernames":"","chatids":"","baseapiurl":"","updatemode":"polling","pollinterval":"300","usesocks":false,"sockshost":"","socksport":"6667","socksusername":"anonymous","sockspassword":"","bothost":"","localbotport":"8443","publicbotport":"8443","privatekey":"","certificate":"","useselfsignedcertificate":false,"sslterminated":false,"verboselogging":false},{"id":"fc5c9554.5f0878","type":"mqtt-broker","z":"","name":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"b1e5fae2.4dc578","type":"mongodb","z":"","hostname":"iot.ac.uma.es","port":"27017","db":"II1","name":""},{"id":"b25567ea.2cea98","type":"mqtt-broker","z":"","name":"","broker":"iot.ac.uma.es","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"a47aace4.089e4","type":"ui_group","z":"","name":"Grupo descarga","tab":"b166ce1e.22b9d","disp":true,"width":"8","collapse":false},{"id":"b166ce1e.22b9d","type":"ui_tab","z":"","name":"Ejemplo descarga","icon":"dashboard","order":1,"disabled":false,"hidden":false}]